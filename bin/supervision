#!/usr/bin/env bash

SUPERVISION_VERSION="0.2.0"

use() {
  versions | grep ^$1$ > /dev/null
  if [ $? -eq 0 ]; then
    ln -sfn $SUPERVISION_VERSIONS_ROOT/$1 $SITEVISION_ROOT
    echo "Now using SiteVision $1."
  else
    echo "SiteVision $1 is not installed."
    exit 1
  fi
}

version() {
  check_for_symlink
  basename `readlink $SITEVISION_ROOT`
}

versions() {
  ls $SUPERVISION_VERSIONS_ROOT | sort
}

console() {
  check_for_symlink
  pushd $SITEVISION_ROOT/bin > /dev/null
  sudo ./sitevision console
  popd > /dev/null
}

undeploy() {
  if [ $1 == "ROOT" ]; then
    echo "You shuld not delete the ROOT application."
    exit 1
  elif [ -z $1 ]; then
    usage
    exit 1
  fi

  local portlet_files=`find /opt/sitevision/tomcat/conf/Catalina/localhost /opt/sitevision/tomcat/webapps /opt/sitevision/data/temp/work -iname "$1*" -maxdepth 1`

  if [ ${#portlet_files} -ne 0 ]; then
    echo "The following files will be deleted:"
    echo ""

    echo "$portlet_files"
    echo ""

    while true; do
      read -p "Do you wish to undeploy $1? " yn
      case $yn in
        [Yy]* ) echo "$portlet_files" | xargs sudo rm -rf && echo "Undeployed $1!"; break;;
        [Nn]* ) exit;;
        * ) echo "Please answer yes or no.";;
      esac
    done
  else
    echo "No files found for portlet $1."
  fi
}

install_sitevision() {
  case $1 in
    "2.6.2_07" )
      install_sitevision_version "2.6.2_07" "http://www.sitevision.se/webdav/files/Kundwebb/Installationsfiler/2.6/sitevision-2.6.2_07-705.zip"
      ;;
    *)
      usage
      exit 1
      ;;
  esac
}

supervision_version() {
  echo "supervision $SUPERVISION_VERSION"
}

usage() {
  supervision_version
  echo "usage: supervision <command> [<args>]"
  echo ""
  echo "What supervision can do for you:"
  echo "   use           Set the SiteVision version"
  echo "   version       Show the current SiteVision version"
  echo "   versions      List all SiteVision versions known to supervision"
  echo "   install       Install SiteVision, available version: 2.6.2_07"
  echo "   console       Start the current SiteVision version in console mode"
  echo "   undeploy      Undeploy a SiteVision portlet"
}

bootstrap() {
  mkdir -p $SUPERVISION_VERSIONS_ROOT $TEMP_PATH

  hash java curl unzip 2>&- && return
  echo "You don't seem to have the necessary prerequisites for running supervision."
  echo ""
  echo "Please make sure you have the following:"
  echo "   * java"
  echo "   * curl"
  echo "   * unzip"

  exit 1
}

check_for_symlink() {
  if ! [ -L $SITEVISION_ROOT -a -d $SITEVISION_ROOT ]; then
    echo "No SiteVision version is set."
    exit 1
  fi
}

download_is_complete() {
  unzip -t $1 > /dev/null 2> /dev/null
}

download_file() {
  echo "You have to authenticate with your SiteVision Customer Web credentials."
  echo ""
  read -p  "  Username: " username
  read -sp "  Password: " password
  echo ""
  echo ""

  curl -f --user "$username:$password" -C - $1 -o $2
}

install_sitevision_version() {
  local url=$2
  local version=$1
  local versionpath="$SUPERVISION_VERSIONS_ROOT/$version"
  local filepath="$TEMP_PATH/$version.zip"

  if [ ! -d $versionpath ]; then
    if ! download_is_complete $filepath; then
      download_file $url $filepath
    fi

    if [ $? -eq 0 ]; then
      unzip $filepath -d $versionpath &&
        chmod +x $versionpath/bin/*

      if [ $? -eq 0 ]; then
        echo "Installation complete."
      else
        echo "Installation failed."
        exit 1
      fi
    fi
  else
    echo "Sitevision $version seems to be installed."
  fi
}

SUPERVISION_ROOT="$HOME/.supervision"
SUPERVISION_VERSIONS_ROOT="$SUPERVISION_ROOT/versions"
SITEVISION_ROOT="/opt/sitevision"
TEMP_PATH="/tmp/supervision"

bootstrap

case $1 in
  "use" )
    use $2
    ;;
  "versions" )
    versions
    ;;
  "version" )
    version
    ;;
  "install" )
    install_sitevision $2
    ;;
  "console" )
    console
    ;;
  "undeploy" )
    undeploy $2
    ;;
  "--version" )
    supervision_version
    ;;
  *)
    usage
    exit 1
    ;;
esac

exit 0
